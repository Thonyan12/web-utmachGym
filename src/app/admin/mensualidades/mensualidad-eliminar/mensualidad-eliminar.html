<div class="d-flex" style="min-height: 100vh;">
  <app-mensualidad-sidebar></app-mensualidad-sidebar>

  <div class="flex-grow-1 p-4 bg-light">
    <div class="container mt-4">
      <h3 class="fw-bold m-0 mb-4" style="color: #14213d;">
        <i class="bi bi-trash me-2"></i> Eliminar Mensualidad
      </h3>

      <!-- Form de búsqueda por cédula o nombre -->
      <form (ngSubmit)="buscarPorCedulaONombre()" #buscarForm="ngForm" class="mb-3">
        <div class="row g-2">
          <div class="col-md-9">
            <input
              type="text"
              class="form-control"
              placeholder="Ingrese cédula o nombre del miembro"
              name="consulta"
              [(ngModel)]="consulta"
              required
            />
          </div>
          <div class="col-md-3 d-grid">
            <button type="submit" class="btn btn-primary" [disabled]="cargando">
              {{ cargando ? 'Buscando...' : 'Buscar' }}
            </button>
          </div>
        </div>
      </form>

      <!-- Mensaje general -->
      <div *ngIf="mensaje" class="alert alert-info">
        {{ mensaje }}
      </div>

      <!-- Resultado: lista de mensualidades encontradas -->
      <div *ngIf="foundCount > 0" class="mb-3">
        <h6>Mensualidades encontradas (seleccione para ver detalles)</h6>
        <ul class="list-group">
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
            *ngFor="let m of mensualidadesEncontradas; let i = index"
            [class.active]="mensualidad === m"
          >
            <div>
              <strong>{{ getMemberDisplayName(m.id_miembro) }}</strong>
              <div class="text-muted small">
                Inicio: {{ m.fecha_inicio }} — Fin: {{ m.fecha_fin }} — Monto: ${{ m.monto }}
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-secondary" (click)="mensualidad = m; mensaje = ''">
                Seleccionar
              </button>
            </div>
          </li>
        </ul>
      </div>

      <!-- Si no hay resultados -->
      <div *ngIf="foundCount === 0 && !cargando && mensaje === ''" class="alert alert-warning">
        No se han encontrado mensualidades para la búsqueda indicada.
      </div>

      <!-- Panel detalle / confirmación -->
      <div *ngIf="mensualidad" class="card shadow-sm mt-4">
        <div class="card-body">
          <h5 class="card-title">Detalle de Mensualidad</h5>

          <!-- Mostrar nombre del miembro -->
          <div class="mb-3">
            <label class="form-label">Miembro</label>
            <input
              type="text"
              class="form-control"
              [value]="getMemberDisplayName(mensualidad.id_miembro)"
              readonly
            />
          </div>

          <!-- Campos rellenados (id_mensualidad oculto) -->
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Fecha Inicio</label>
              <input type="date" class="form-control" [(ngModel)]="mensualidad.fecha_inicio" name="fecha_inicio" readonly />
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Fecha Fin</label>
              <input type="date" class="form-control" [(ngModel)]="mensualidad.fecha_fin" name="fecha_fin" readonly />
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Monto</label>
              <input type="number" class="form-control" [(ngModel)]="mensualidad.monto" name="monto" readonly />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Estado</label>
            <input type="text" class="form-control" [(ngModel)]="mensualidad.estado_mensualidad" name="estado_mensualidad" readonly />
          </div>

          <div class="mb-3">
            <label class="form-label">Fecha de Registro</label>
            <input type="text" class="form-control" [(ngModel)]="mensualidad.f_registro" name="f_registro" readonly />
          </div>

          <!-- Botones: confirmar eliminación / cancelar / volver -->
          <div class="d-flex gap-2 justify-content-end">
            <button type="button" class="btn btn-secondary" (click)="mensualidad = null; mensualidadesEncontradas = []; consulta = ''">
              Volver
            </button>

            <button type="button" class="btn btn-danger" (click)="confirmarEliminar()" [disabled]="mostrarConfirmacion">
              Eliminar
            </button>
          </div>

          <!-- Confirmación -->
          <div *ngIf="mostrarConfirmacion" class="mt-3">
            <div class="alert alert-danger">
              ¿Confirma que desea eliminar esta mensualidad?
              <div class="d-flex gap-2 justify-content-end mt-2">
                <button type="button" class="btn btn-outline-secondary" (click)="cancelarEliminar()">Cancelar</button>
                <button type="button" class="btn btn-danger" (click)="eliminar()">Confirmar Eliminar</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>